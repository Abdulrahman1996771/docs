---
title: TiDB Cloud Replication
summary: Learn how to create a replica to stream data from a primary TiDB cluster to a secondary TiDB cluster.
---

# TiDB Cloudレプリケーション {#tidb-cloud-replication}

TiDB Cloudレプリケーションは、TiDBTiDB Cloud内のプライマリ TiDBクラスタ用に、継続的にレプリケートされる読み取り可能なセカンダリ TiDBクラスタを作成できるようにする機能です。この読み取り可能なセカンダリクラスタ(クロスリージョン レプリケーション、セカンダリ レプリケーション、または geo レプリケーションとも呼ばれます) は、プライマリ TiDBクラスタと同じリージョンに配置することも、より一般的には別のリージョンに配置することもできます。

TiDB Cloud Replication を使用すると、地域的な災害や大規模な障害が発生した場合に、データベースの迅速なディザスター リカバリーを実行でき、ビジネスの継続性を実現できます。セカンダリクラスタをセットアップしたら、別のリージョンのセカンダリクラスタへの地理的フェールオーバーを手動で開始できます。

> **警告：**
>
> 現在、 **TiDB Cloudレプリケーション**機能は<strong>パブリック プレビュー</strong>段階であり、次の制限があります。
>
> -   1 つのプライマリクラスタは、1 つのレプリケーションのみを持つことができます。
> -   セカンダリクラスタを別のクラスタへの**TiDB Cloud Replication**のソースとして使用することはできません。
> -   **TiDB Cloud Replication**は[**Apache Kafka にシンクする**](/tidb-cloud/changefeed-sink-to-apache-kafka.md)と[**MySQL にシンク**](/tidb-cloud/changefeed-sink-to-mysql.md)に矛盾します。 <strong>TiDB Cloudレプリケーション</strong>が有効になっている場合、プライマリ クラスタもセカンダリクラスタも、 <strong>Sink to Apache Kafka</strong>または<strong>Sink to MySQL</strong> changefeed を使用できず、その逆も同様です。
> -   TiDB Cloudは TiCDC を使用してレプリケーションを確立するため、同じ[TiCDCとしての制限](https://docs.pingcap.com/tidb/stable/ticdc-overview#restrictions)を持ちます。

アプリケーションのレプリケーションをサポートするには、プライマリ リージョンとセカンダリ リージョンの両方にアプリケーションをデプロイし、各アプリケーションが同じリージョン内の TiDBクラスタに接続されていることを確認する必要があります。セカンダリ リージョンのアプリケーションはスタンバイ状態です。プライマリ リージョンに障害が発生した場合は、「デタッチ」操作を開始してセカンダリ リージョンの TiDBクラスタをアクティブにし、すべてのデータ トラフィックをセカンダリ リージョンのアプリケーションに転送できます。

次の図は、 TiDB Cloud Replication を使用した geo 冗長クラウド アプリケーションの一般的な展開を示しています。

<!-- https://www.figma.com/file/DaevXzW4aq35QodwZEkcTS/DBaaS-Architecture-Chart-(high-level)-(Copy)?node-id=0%3A1 -->

![TiDB Cloud Replication](/media/tidb-cloud/changefeed-replication-deployment.png)

セカンダリ TiDBクラスタの作成は、ビジネス継続性ソリューションの一部にすぎません。壊滅的な障害の後にアプリケーション (またはサービス) をエンドツーエンドで回復するには、アプリケーションのすべてのコンポーネントと依存サービスを確実に復元できるようにする必要もあります。

-   アプリケーションの各コンポーネントが同じ障害に対して回復力があり、アプリケーションの目標復旧時間 (RTO) 内に使用可能になるかどうかを確認します。アプリケーションの典型的なコンポーネントには、クライアント ソフトウェア (カスタム JavaScript を使用したブラウザーなど)、Web フロント エンド、ストレージ、および DNS が含まれます。
-   依存するすべてのサービスを特定し、これらのサービスの保証と機能を確認して、これらのサービスのフェイルオーバー中にアプリケーションが動作することを確認します。

## TiDB Cloud Replication の用語と機能 {#terminology-and-capabilities-of-tidb-cloud-replication}

### 自動非同期レプリケーション {#automatic-asynchronous-replication}

1 次 TiDBクラスタごとに、2 次クラスタを 1 つだけ作成できます。 TiDB Cloudは、プライマリ TiDBクラスタの完全バックアップを作成し、そのバックアップを新しく作成されたセカンダリクラスタに復元します。これにより、セカンダリクラスタにすべての既存のデータがあることが保証されます。二次クラスタが作成されると、一次クラスタでのすべてのデータ変更が二次クラスタに非同期で複製されクラスタ。

### 読み取り可能な二次クラスタ {#readable-secondary-cluster}

セカンダリクラスタは読み取り専用モードです。リアルタイム データの要件が低い読み取り専用のワークロードがある場合は、それをセカンダリクラスタに分散できます。

同じリージョンで読み取りが集中するシナリオを満たすために、 **TiDB Cloudレプリケーション**を使用して、プライマリクラスタと同じリージョンに読み取り可能なセカンダリクラスタを作成できます。ただし、同じリージョン内のセカンダリクラスタは、大規模な停止や壊滅的な障害に対する追加の回復力を提供しないため、リージョンの災害復旧目的のフェイルオーバー ターゲットとして使用しないでください。

### 計画的切り離し {#planned-detach}

**計画的切り離し**は、手動でトリガーできます。ほとんどの場合、災害復旧訓練などの計画的なメンテナンスに使用されます。<strong>計画的デタッチ</strong>により、すべてのデータ変更がデータ損失なしでセカンダリクラスタにレプリケートされます (RPO=0)。 RTO については、プライマリ クラスタとセカンダリ クラスタ間のレプリケーション ラグに依存します。ほとんどの場合、RTO は数分のレベルです。

**Planned Detach**は、2 次クラスタを 1 次クラスタから個々のクラスタに分離します。 <strong>Planned Detach</strong>がトリガーされると、次の手順が実行されます。

1.  新しいトランザクションがプライマリクラスタにコミットされないように、プライマリクラスタを読み取り専用に設定します。
2.  二次クラスタが一次クラスタと完全に同期されるまで待機しクラスタ。
3.  プライマリ クラスタからセカンダリクラスタへのレプリケーションを停止します。
4.  元のセカンダリクラスタを書き込み可能として設定し、ビジネスに利用できるようにします。

**Planned Detach**が完了すると、元の主クラスタは読み取り専用に設定されます。元の主クラスタにまだ書き込む必要がある場合は、次のいずれかを実行して、クラスタを明示的に書き込み可能に設定できます。

-   クラスタの詳細ページに移動し、[**設定]**をクリックしてから、[<strong>書き込み可能</strong>にする] ドロップダウン ボタンをクリックします。
-   元のプライマリクラスタの SQL ポートに接続し、次のステートメントを実行します。

    {{< copyable "" >}}

    ```sql
    set global tidb_super_read_only=OFF;
    ```

### 強制的に切り離す {#force-detach}

計画外の停止から回復するには、 **Force Detach**を使用します。プライマリクラスタが配置されているリージョンで壊滅的な障害が発生した場合は、 <strong>Force Detach</strong>を使用して、セカンダリクラスタが可能な限り迅速にビジネスに対応し、ビジネスの継続性を確保できるようにする必要があります。この操作により、セカンダリクラスタがすぐに個別のクラスタとして機能し、レプリケートされていないデータを待機しないため、RPO はプライマリとセカンダリのレプリケーション ラグに依存し、RTO は<strong>Force Detach</strong>がトリガーされる速度に依存します。

**Force Detach**は、セカンダリクラスタをプライマリクラスタから個別のクラスタにデタッチします。 <strong>Force Detach</strong>がトリガーされると、次の手順を実行します：

1.  プライマリ クラスタからセカンダリクラスタへのデータ複製をただちに停止します。
2.  ワークロードの処理を開始できるように、元のセカンダリクラスタを書き込み可能に設定します。
3.  元のプライマリクラスタがまだアクセス可能な場合、または元のプライマリクラスタが復旧した場合、 TiDB Cloudはそれを読み取り専用に設定して、新しいトランザクションがコミットされないようにします。

元の主クラスタが停止から回復した後でも、2 つのクラスタのデータを比較することで、元の主クラスタで実行されたが元の二次クラスタでは実行されなかったトランザクションを確認し、手動で複製するかどうかを決定する機会がありクラスタ。ビジネス状況に基づいて、これらの非同期トランザクションを元のセカンダリクラスタに送信します。

セカンダリクラスタをデタッチすると、プライマリ クラスタとセカンダリ クラスタ間のデータ レプリケーション トポロジは存在しなくなります。元の主クラスタは読み取り専用モードに設定され、元の副クラスタは書き込み可能になります。元のプライマリクラスタで DML または DDL が計画されている場合は、次のいずれかを実行して読み取り専用モードを手動で無効にする必要があります。

-   クラスタの詳細ページに移動し、[**設定]**をクリックしてから、[<strong>書き込み可能</strong>にする] ドロップダウン ボタンをクリックします。
-   元のプライマリクラスタの SQL ポートに接続し、次のステートメントを実行します。

    {{< copyable "" >}}

    ```sql
    set global tidb_super_read_only=OFF;
    ```

## TiDB Cloudレプリケーションの構成 {#configure-tidb-cloud-replication}

TiDB Cloudレプリケーションを構成するには、次の手順を実行します。

1.  TiDBクラスタの**Changefeed**タブに移動します。
2.  [ **TiDB クラスターのレプリカを作成する] を**クリックします。
3.  データベースのユーザー名とパスワードを入力します。
4.  セカンダリクラスタのリージョンを選択します。
5.  [**作成]**をクリックします。しばらくすると、シンクが動作を開始し、シンクのステータスが &quot; <strong>Producing</strong> &quot; に変わります。

**Planned Detach**または<strong>Force Detach</strong>をトリガーするには、次の手順を実行します。

1.  TiDBクラスタの**Changefeed**タブに移動します。
2.  [ **TiDB クラスターのレプリカを作成する] を**クリックします。
3.  [**計画されたデタッチ]**または [<strong>強制デタッチ</strong>] をクリックします。

## プライマリクラスタをスケーリングする {#scale-the-primary-cluster}

セカンダリクラスタを切断せずに、プライマリクラスタをスケールアウトまたはスケールインできます。プライマリクラスタがスケーリングされると、セカンダリクラスタは自動的に同じスケーリングに従います。

## 一次二次ラグを監視する {#monitor-the-primary-secondary-lag}

RPO に関する遅延を監視するには、次の手順を実行します。

1.  TiDBクラスタの**Changefeed**タブに移動します。
2.  [ **TiDB クラスターのレプリカを作成する] を**クリックします。
3.  一次二次クラスタのラグが見られます。
